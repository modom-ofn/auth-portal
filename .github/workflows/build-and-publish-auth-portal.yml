name: build-and-publish

on:
  push:
    branches: [ "main", "dev", "v*" ]
    tags: [ "v*" ]
    paths:
      - "auth-portal/**"
      - ".github/workflows/build-and-publish-auth-portal.yml"
      - "VERSION"
      - "MAKEFILE"
      - "auth-portal-full-stack-dev_docker-compose.yml"
      - "auth-portal-full-stack-dev.env"
  pull_request:
    branches: [ "main" ]
    paths:
      - "auth-portal/**"
      - ".github/workflows/build-and-publish-auth-portal.yml"
      - "VERSION"
      - "MAKEFILE"
      - "auth-portal-full-stack-dev_docker-compose.yml"
      - "auth-portal-full-stack-dev.env"

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # create releases
      packages: write
      id-token: write    # for provenance
    env:
      IMAGE: modomofn/auth-portal
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Secret scan (Gitleaks)
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
        with:
          args: detect --source . --no-git --redact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go cache (optional)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130

      - name: Set up Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          SHA="${GITHUB_SHA::7}"
          echo "sha=$SHA" >> $GITHUB_OUTPUT

          VERSION_FILE="VERSION"
          VERSION=""
          if [[ -f "$VERSION_FILE" ]]; then
            VERSION=$(tr -d '\r\n' < "$VERSION_FILE")
            VERSION=${VERSION#v}
          fi
          if [[ -n "$VERSION" ]]; then
            echo "version_plain=$VERSION" >> $GITHUB_OUTPUT
          fi

          case "$GITHUB_REF" in
            refs/heads/main)
              echo "channel=latest" >> $GITHUB_OUTPUT
              if [[ -n "$VERSION" ]]; then
                echo "version_tag=v$VERSION" >> $GITHUB_OUTPUT
              fi
              ;;
            refs/heads/dev)
              echo "channel=edge" >> $GITHUB_OUTPUT
              if [[ -n "$VERSION" ]]; then
                echo "dev_version_tag=v${VERSION}-dev-$SHA" >> $GITHUB_OUTPUT
              fi
              ;;
            refs/heads/v[0-9]*)
              BRANCH_VERSION="${GITHUB_REF#refs/heads/}"
              if [[ -n "$VERSION" ]]; then
                echo "version_tag=v$VERSION" >> $GITHUB_OUTPUT
              else
                echo "version_tag=$BRANCH_VERSION" >> $GITHUB_OUTPUT
              fi
              if [[ "$BRANCH_VERSION" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
                echo "ver=$BRANCH_VERSION" >> $GITHUB_OUTPUT
                echo "major=v${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
                echo "minor=v${BASH_REMATCH[1]}.${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
              fi
              ;;
          esac

          if [[ "$GITHUB_REF" =~ refs/tags/v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            VER="${BASH_REMATCH[0]#refs/tags/}"
            MAJOR="v${BASH_REMATCH[1]}"
            MINOR="v${BASH_REMATCH[1]}.${BASH_REMATCH[2]}"
            echo "ver=$VER" >> $GITHUB_OUTPUT
            echo "major=$MAJOR" >> $GITHUB_OUTPUT
            echo "minor=$MINOR" >> $GITHUB_OUTPUT
          fi

      - name: Build and push (multi-arch)
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: auth-portal
          file: auth-portal/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          provenance: true
          sbom: true
          tags: |
            ${{ env.IMAGE }}:${{ steps.vars.outputs.sha }}
            ${{ steps.vars.outputs.channel && format('{0}:{1}', env.IMAGE, steps.vars.outputs.channel) || '' }}
            ${{ steps.vars.outputs.version_tag && format('{0}:{1}', env.IMAGE, steps.vars.outputs.version_tag) || '' }}
            ${{ steps.vars.outputs.dev_version_tag && format('{0}:{1}', env.IMAGE, steps.vars.outputs.dev_version_tag) || '' }}
            ${{ steps.vars.outputs.ver && format('{0}:{1}', env.IMAGE, steps.vars.outputs.ver) || '' }}
            ${{ steps.vars.outputs.minor && format('{0}:{1}', env.IMAGE, steps.vars.outputs.minor) || '' }}
            ${{ steps.vars.outputs.major && format('{0}:{1}', env.IMAGE, steps.vars.outputs.major) || '' }}

      - name: Install Syft
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"
          SYFT_VERSION="v0.99.0"
          SYFT_URL="https://github.com/anchore/syft/releases/download/${SYFT_VERSION}/syft_${SYFT_VERSION#v}_linux_amd64.tar.gz"
          curl -sSfL "$SYFT_URL" -o /tmp/syft.tgz
          tar -xzf /tmp/syft.tgz -C /tmp syft
          install /tmp/syft "$HOME/.local/bin/syft"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          syft version

      - name: Generate SBOM (Syft)
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          syft "${IMAGE}:${{ steps.vars.outputs.sha }}" -o cyclonedx-json > auth-portal-sbom.cdx.json
          ls -lh auth-portal-sbom.cdx.json

      - name: Upload SBOM artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: auth-portal-sbom-${{ steps.vars.outputs.sha }}
          path: auth-portal-sbom.cdx.json
          retention-days: 14

      - name: Install Grype
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"
          GRYPE_VERSION="v0.99.1"
          GRYPE_URL="https://github.com/anchore/grype/releases/download/${GRYPE_VERSION}/grype_${GRYPE_VERSION#v}_linux_amd64.tar.gz"
          curl -sSfL "$GRYPE_URL" -o /tmp/grype.tgz
          tar -xzf /tmp/grype.tgz -C /tmp grype
          install /tmp/grype "$HOME/.local/bin/grype"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          grype version

      - name: Vulnerability scan (Grype)
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          grype sbom:auth-portal-sbom.cdx.json -o table --fail-on high

      - name: Scan image with Trivy
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE }}:${{ steps.vars.outputs.sha }}
          vuln-type: 'os,library'
          format: table
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Create GitHub Release (for tags)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          generate_release_notes: true
          files: auth-portal-sbom.cdx.json
