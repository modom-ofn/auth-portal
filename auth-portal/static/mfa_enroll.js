document.addEventListener('DOMContentLoaded',()=>{const e=document.getElementById('status-block'),t=document.getElementById('start-enroll'),n=document.getElementById('reset-enroll'),o=document.getElementById('pending-panel'),s=document.getElementById('qr-container'),a=document.getElementById('totp-secret'),r=document.getElementById('otpauth-link'),c=document.getElementById('verify-form'),l=document.getElementById('verify-code'),d=document.getElementById('verify-message'),u=document.getElementById('recovery-panel');function i(t,n){t&&(t.innerHTML=n)}function y(t,n){t&&(t.style.color='#f97316',t.textContent=n)}function m(t,n){t&&(t.style.color='#22c55e',t.textContent=n)}async function f(){try{const o=await fetch('/mfa/enroll/status',{credentials:'same-origin'});if(!o.ok)throw new Error('status request failed');const s=await o.json(),a=[];t&&(s.enabled?t.textContent='Rotate secret':s.pending?t.textContent='Resume enrollment':t.textContent='Start enrollment'),s.enabled?(a.push('<strong>MFA is enabled.</strong>'),s.lastUsedAt&&a.push('Last used '+new Date(s.lastUsedAt).toLocaleString()),typeof s.recoveryCount=='number'&&a.push(s.recoveryCount+' recovery codes remaining.')):s.pending?a.push('<strong>MFA enrollment is pending verification.</strong>'):a.push('MFA is not enabled for this account yet.'),s.enforced&&a.push('MFA is enforced for all users.'),i(e,a.join(' ')),n&&(n.style.display=s.pending?'inline-flex':'none')}catch(t){console.error(t),i(e,'Could not load MFA status. Please refresh the page.')}}async function h(){t&&(t.disabled=!0),n&&(n.disabled=!0),d&&(d.textContent=''),u&&(u.style.display='none');try{const e=await fetch('/mfa/enroll/start',{method:'POST',credentials:'same-origin',headers:{Accept:'application/json'}});if(!e.ok){const t=await e.text();throw new Error(t||'Failed to start enrollment')}const i=await e.json();a&&(a.textContent=i.secret),r&&(r.href=i.otpauth,r.textContent=i.otpauth),s&&(s.innerHTML='',(()=>{const e=document.createElement('img');e.alt='Authenticator QR code',e.width=220,e.height=220,e.src='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(i.otpauth),s.appendChild(e)})()),o&&(o.style.display='block');const y=new URL(window.location.href);y.searchParams.set('pending','1'),window.history.replaceState({},'',y.toString()),l&&l.focus(),m(d,'Secret generated. Add it to your authenticator, then enter the 6-digit code below.'),await f()}catch(e){console.error(e),i(statusBlock,'Failed to start enrollment. Please try again.')}finally{t&&(t.disabled=!1),n&&(n.disabled=!1)}}async function w(e){if(e.preventDefault(),d&&(d.textContent=''),!l)return;const t=l.value.trim();if(!t){y(d,'Enter your authenticator code.'),l.focus();return}try{const e=await fetch('/mfa/enroll/verify',{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/json',Accept:'application/json'},body:JSON.stringify({code:t})});if(console.debug('verify status',e.status),e.status===303){const t=e.headers.get('Location');if(t){window.location.assign(t);return}}if(!e.ok){let t='Verification failed. Check your code and try again.';try{const n=await e.json();n&&n.error&&(t=n.error)}catch(e){console.warn('verify json parse failed',e)}y(d,t),l.select();return}const n=await e.json().catch(()=>({}));m(d,'MFA verified. Store your recovery codes securely.'),Array.isArray(n.recoveryCodes)&&n.recoveryCodes.length&&(function(){const e=document.getElementById('recovery-codes');if(!e)return;e.innerHTML='',n.recoveryCodes.forEach(t=>{const n=document.createElement('div');n.style.padding='8px',n.style.border='1px solid var(--border)',n.style.borderRadius='8px',n.style.background='#0f172a',n.style.textAlign='center',n.textContent=t,e.appendChild(n)})})(),u&&(u.style.display='block'),o&&(o.style.display='none'),l&&(l.value=''),await f(),window.dispatchEvent(new Event('mfa-verified'))}catch(t){console.error('verify failed',t),y(d,'Could not verify the code. Please try again.')}}t&&t.addEventListener('click',h),n&&n.addEventListener('click',h),c&&c.addEventListener('submit',w),f();const p=new URL(window.location.href);p.searchParams.get('pending')&&(o&&(o.style.display='block'),l&&l.focus());});
