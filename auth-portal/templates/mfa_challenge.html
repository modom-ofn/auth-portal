<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AuthPortal - Multi-factor Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg">
  <main class="center">
    <section class="card">
      <div class="brand" style="margin-bottom: 1.5rem;">
        <h1>Verify your sign-in</h1>
        <p class="muted">Hi {{ if .Username }}{{ .Username }}{{ else }}there{{ end }}, finish signing in with a code from {{ .Issuer }}.</p>
      </div>
      <form id="mfa-challenge-form" autocomplete="one-time-code" novalidate>
        <label for="mfa-code">Authenticator or recovery code</label>
        <input id="mfa-code" name="code" type="text" inputmode="text" autocapitalize="characters" autocomplete="one-time-code" spellcheck="false" placeholder="123456 or ABCDE-12345" required>
        <p class="muted">Enter your 6-digit authenticator code. You can also paste one of your recovery codes if you saved them.</p>
        <button type="submit" id="mfa-submit">Verify and continue</button>
      </form>
      <div id="mfa-error" role="alert" style="display:none;margin-top:1rem;"></div>
      <div class="muted" style="margin-top:1.25rem;font-size:0.9rem;">
        <p>If you lost access to your authenticator, use a recovery code or contact an administrator for help.</p>
      </div>
      <form method="post" action="/logout" style="margin-top:1.5rem;">
        <button type="submit">Start over</button>
      </form>
    </section>
  </main>

  <script>
  (() => {
    const form = document.getElementById('mfa-challenge-form');
    const codeInput = document.getElementById('mfa-code');
    const submitBtn = document.getElementById('mfa-submit');
    const errorBox = document.getElementById('mfa-error');
    if (codeInput) {
      setTimeout(() => codeInput.focus({ preventScroll: true }), 50);
    }

    const showError = (message) => {
      if (!errorBox) return;
      errorBox.textContent = message || 'Verification failed. Please try again.';
      errorBox.style.display = 'block';
    };

    const hideError = () => {
      if (!errorBox) return;
      errorBox.textContent = '';
      errorBox.style.display = 'none';
    };

    const setLoading = (loading) => {
      if (!submitBtn) return;
      submitBtn.disabled = loading;
      submitBtn.textContent = loading ? 'Verifyingâ€¦' : 'Verify and continue';
    };

    form?.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const code = codeInput?.value?.trim();
      hideError();
      if (!code) {
        showError('Enter your authenticator or recovery code.');
        codeInput?.focus();
        return;
      }

      setLoading(true);
      try {
        const res = await fetch('/mfa/challenge/verify', {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code })
        });

        const data = await res.json().catch(() => ({}));
        if (res.ok && data && data.ok) {
          window.location.assign(data.redirect || '/home');
          return;
        }

        const message = (data && data.error) || 'Verification failed. Check your code and try again.';
        showError(message);
        codeInput?.focus();
        codeInput?.select();
      } catch (err) {
        console.error('mfa verify failed', err);
        showError('Could not verify the code. Check your connection and try again.');
      } finally {
        setLoading(false);
      }
    });
  })();
  </script>
</body>
</html>
